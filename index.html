<!DOCTYPE html>
<html lang="en" class="dark"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Bookmarks</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.379.0/dist/umd/lucide.min.js" id="lucide-script"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1c1e;
            background-image: radial-gradient(circle at top center, #2c2c30 0%, #1c1c1e 70%);
        }
        /* Custom scrollbars */
        .folder-list::-webkit-scrollbar { width: 6px; }
        .folder-list::-webkit-scrollbar-track { background: #2c2c2e; }
        .folder-list::-webkit-scrollbar-thumb { background: #4a4a4f; border-radius: 10px; }
        
        #breadcrumbs-container::-webkit-scrollbar { height: 2px; }
        #breadcrumbs-container::-webkit-scrollbar-track { background: transparent; }
        #breadcrumbs-container::-webkit-scrollbar-thumb { background: #4a4a4f; border-radius: 2px; }

        /* Animations */
        .animate-sheet-up { animation: sheet-up 0.3s cubic-bezier(0.32, 0.72, 0, 1) forwards; }
        @keyframes sheet-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-modal-in { animation: modal-in 0.2s ease-out forwards; }
        @keyframes modal-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .sortable-ghost { opacity: 0.3; transform: scale(0.95); }
        .sortable-chosen { cursor: grabbing; }
        
        .visually-hidden-file-input {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* Login Overlay Styling */
        #login-overlay {
            background-image: radial-gradient(circle at center, #2d3748 0%, #1a202c 100%);
        }
    </style>
</head>
<body class="text-white overflow-hidden h-screen select-none">

    <!-- ===== LOGIN OVERLAY ===== -->
    <div id="login-overlay" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8 p-4 bg-white/5 rounded-full backdrop-blur-xl border border-white/10 shadow-2xl">
            <i data-lucide="cloud" class="w-16 h-16 text-blue-400"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2">Cloud Bookmarks</h1>
        <p class="text-gray-400 mb-8 max-w-md">Sync your bookmarks across all your devices securely.</p>
        
        <button id="google-signin-btn" class="flex items-center gap-3 bg-white text-gray-900 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition-transform active:scale-95 shadow-lg">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
            Sign in with Google
        </button>
        <p id="login-status" class="mt-4 text-sm text-gray-500 h-5"></p>
    </div>

    <!-- ===== LOADING SPINNER ===== -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-900/50 backdrop-blur-md z-[999] flex items-center justify-center hidden">
        <div class="flex flex-col items-center gap-4">
            <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-300 text-lg font-medium" id="spinner-text">Syncing...</p>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div id="app-container" class="h-screen w-screen flex flex-col hidden">
        
        <!-- HEADER -->
        <header class="sticky top-0 z-30 px-4 sm:px-6 md:px-8 bg-black/30 backdrop-blur-lg border-b border-white/5">
            <div class="flex justify-between items-center pt-6 pb-3"> 
                <!-- Breadcrumbs -->
                <nav id="breadcrumbs-container" class="flex-1 flex items-center space-x-1 overflow-x-auto whitespace-nowrap mask-linear-fade">
                    <!-- Injected via JS -->
                </nav>
                
                <!-- Desktop Actions -->
                <div class="hidden sm:flex items-center space-x-2 ml-4">
                    <button id="desktop-lock-btn" class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="Lock/Unlock Dragging">
                        <i data-lucide="lock" class="w-5 h-5"></i>
                    </button>
                    <div class="w-px h-6 bg-white/10 mx-2"></div>
                    <div class="flex items-center gap-3 bg-white/5 rounded-full pl-1 pr-3 py-1 border border-white/5">
                        <img id="user-avatar" src="" alt="User" class="w-6 h-6 rounded-full">
                        <span id="user-name" class="text-xs font-medium text-gray-300 max-w-[100px] truncate">User</span>
                        <button id="logout-btn" class="ml-2 text-xs text-red-400 hover:text-red-300">Sign Out</button>
                    </div>
                </div>

                <!-- Mobile Menu Toggle -->
                <button id="mobile-menu-btn" class="sm:hidden p-2 text-gray-300 hover:bg-white/10 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- MAIN GRID -->
        <main class="flex-1 overflow-y-auto px-4 sm:px-6 md:px-8 pt-4 pb-32">
            <div id="items-grid" class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-4" style="grid-auto-rows: minmax(min-content, max-content);">
                <!-- Items injected here -->
            </div>
            <div id="empty-state" class="hidden flex-col items-center justify-center h-[60vh] text-gray-500">
                <i data-lucide="folder-open" class="w-16 h-16 mb-4 opacity-50"></i>
                <p class="text-gray-400">Folder is empty</p>
            </div>
        </main>

        <!-- FAB (Add Button) -->
        <button id="fab-add" class="fixed bottom-8 right-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-4 shadow-xl shadow-blue-500/20 transition-all active:scale-90 z-40">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="icon-file-input" accept="image/*" class="visually-hidden-file-input">

    <!-- ===== BOTTOM SHEETS & MODALS ===== -->

    <!-- Add Menu -->
    <div id="add-menu-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden transition-opacity"></div>
    <div id="add-menu" class="fixed bottom-0 left-0 right-0 z-[51] p-4 transform translate-y-full transition-transform duration-300">
        <div class="max-w-md mx-auto space-y-3">
            <div class="bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden">
                <button id="btn-add-link" class="w-full text-left p-4 text-blue-400 font-medium border-b border-white/5 active:bg-white/5">New Bookmark</button>
                <button id="btn-add-folder" class="w-full text-left p-4 text-blue-400 font-medium active:bg-white/5">New Folder</button>
            </div>
            <button id="btn-cancel-add" class="w-full p-4 bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl text-blue-400 font-bold active:bg-white/5">Cancel</button>
        </div>
    </div>

    <!-- Action Menu (Context) -->
    <div id="action-menu-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden"></div>
    <div id="action-menu" class="fixed bottom-0 left-0 right-0 z-[51] p-4 transform translate-y-full transition-transform duration-300">
        <div class="max-w-md mx-auto space-y-3">
            <div class="bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden">
                <button id="btn-edit" class="w-full text-left p-4 text-blue-400 font-medium border-b border-white/5 active:bg-white/5">Edit</button>
                <button id="btn-move" class="w-full text-left p-4 text-blue-400 font-medium border-b border-white/5 active:bg-white/5">Move</button>
                <button id="btn-delete" class="w-full text-left p-4 text-red-500 font-medium active:bg-white/5">Delete</button>
            </div>
            <button id="btn-cancel-action" class="w-full p-4 bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl text-blue-400 font-bold active:bg-white/5">Cancel</button>
        </div>
    </div>

    <!-- Mobile Settings Menu -->
    <div id="settings-menu-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden"></div>
    <div id="settings-menu" class="fixed bottom-0 left-0 right-0 z-[51] p-4 transform translate-y-full transition-transform duration-300">
        <div class="max-w-md mx-auto space-y-3">
            <div class="bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-white/5 flex items-center gap-3">
                    <img id="mobile-user-avatar" src="" class="w-8 h-8 rounded-full">
                    <div class="overflow-hidden">
                        <p id="mobile-user-name" class="text-sm font-semibold text-white truncate">User</p>
                        <p id="mobile-user-email" class="text-xs text-gray-400 truncate">email@example.com</p>
                    </div>
                </div>
                <button id="mobile-lock-btn" class="w-full text-left p-4 text-gray-200 font-medium border-b border-white/5 active:bg-white/5 flex justify-between">
                    <span>Lock Dragging</span>
                    <i data-lucide="lock" class="w-4 h-4"></i>
                </button>
                <button id="mobile-logout-btn" class="w-full text-left p-4 text-red-500 font-medium active:bg-white/5">Sign Out</button>
            </div>
            <button id="btn-cancel-settings" class="w-full p-4 bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl text-blue-400 font-bold active:bg-white/5">Done</button>
        </div>
    </div>

    <!-- Input Modal (Center) -->
    <div id="input-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="input-modal-bg"></div>
        <div class="relative bg-gray-800 border border-white/10 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-modal-in">
            <h2 id="input-title" class="text-xl font-bold mb-4">Add Item</h2>
            <form id="input-form" class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1">Name</label>
                    <input type="text" id="input-name" class="w-full bg-black/20 text-white rounded-lg p-3 border border-white/10 focus:border-blue-500 outline-none transition-colors" placeholder="My Bookmark">
                </div>
                <div id="url-group">
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1">URL</label>
                    <input type="url" id="input-url" class="w-full bg-black/20 text-white rounded-lg p-3 border border-white/10 focus:border-blue-500 outline-none transition-colors" placeholder="https://google.com">
                </div>
                <!-- Icon Picker -->
                <div id="icon-group" class="flex items-center gap-3 pt-2">
                    <div class="relative group cursor-pointer w-12 h-12 flex-shrink-0" id="icon-preview-click">
                        <img id="input-icon-preview" src="" class="w-12 h-12 rounded-xl bg-white/5 object-cover border border-white/10">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-xl opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="upload" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs text-gray-400 mb-1">Icon (Auto-fetched or Click to Upload)</p>
                        <button type="button" id="btn-reset-icon" class="text-xs text-blue-400 hover:text-blue-300">Reset to default</button>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="btn-cancel-input" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Move Modal -->
    <div id="move-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="move-modal-bg"></div>
        <div class="relative bg-gray-800 border border-white/10 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-modal-in flex flex-col max-h-[70vh]">
            <h2 class="text-xl font-bold mb-4">Move to...</h2>
            <div id="move-breadcrumbs" class="flex items-center space-x-1 overflow-x-auto whitespace-nowrap pb-3 border-b border-white/10 mb-2 text-sm text-gray-400"></div>
            <div id="move-list" class="flex-1 overflow-y-auto folder-list min-h-[150px]"></div>
            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-white/10">
                <button type="button" id="btn-cancel-move" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button type="button" id="btn-confirm-move" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">Move Here</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-gray-800 border border-white/10 text-white py-2 px-6 rounded-full shadow-2xl transform -translate-y-[200%] transition-transform duration-300 z-[9999] flex items-center gap-2">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
        <span id="toast-msg" class="text-sm font-medium">Done</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, writeBatch, enableIndexedDbPersistence, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8Bsa_MPuz_2BtlC-k4pwyvEOFxcIIfKs",
            authDomain: "my-bookmark-app-1fe39.firebaseapp.com",
            projectId: "my-bookmark-app-1fe39",
            storageBucket: "my-bookmark-app-1fe39.firebasestorage.app",
            messagingSenderId: "1014980538022",
            appId: "1:1014980538022:web:810f2eae78c2423271ce67"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable Offline Persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.warn('Persistence not supported by browser');
            }
        });

        // --- STATE & VARS ---
        let currentUser = null;
        let localItems = {}; // Local cache of Firestore data
        let currentFolderId = "root";
        let breadcrumbs = [{ id: "root", name: "Home" }];
        let selectedItem = null;
        let isDragLocked = true;
        let moveTargetId = "root";
        let moveCrumbPath = [{ id: "root", name: "Home" }];
        let sortableInstance = null;
        let unsubscribeSnapshot = null;

        // --- DOM REFERENCES ---
        const els = {
            loginOverlay: document.getElementById('login-overlay'),
            appContainer: document.getElementById('app-container'),
            googleBtn: document.getElementById('google-signin-btn'),
            loginStatus: document.getElementById('login-status'),
            spinner: document.getElementById('loading-spinner'),
            itemsGrid: document.getElementById('items-grid'),
            breadcrumbs: document.getElementById('breadcrumbs-container'),
            emptyState: document.getElementById('empty-state'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            mobileAvatar: document.getElementById('mobile-user-avatar'),
            mobileName: document.getElementById('mobile-user-name'),
            mobileEmail: document.getElementById('mobile-user-email'),
            logoutBtn: document.getElementById('logout-btn'),
            mobileLogoutBtn: document.getElementById('mobile-logout-btn'),
            fab: document.getElementById('fab-add'),
            desktopLock: document.getElementById('desktop-lock-btn'),
            mobileLock: document.getElementById('mobile-lock-btn'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            
            // Modals
            addMenu: document.getElementById('add-menu'),
            addOverlay: document.getElementById('add-menu-overlay'),
            actionMenu: document.getElementById('action-menu'),
            actionOverlay: document.getElementById('action-menu-overlay'),
            settingsMenu: document.getElementById('settings-menu'),
            settingsOverlay: document.getElementById('settings-menu-overlay'),
            inputModal: document.getElementById('input-modal'),
            inputModalBg: document.getElementById('input-modal-bg'),
            moveModal: document.getElementById('move-modal'),
            moveModalBg: document.getElementById('move-modal-bg'),
            
            // Form
            inputForm: document.getElementById('input-form'),
            inputName: document.getElementById('input-name'),
            inputUrl: document.getElementById('input-url'),
            inputPreview: document.getElementById('input-icon-preview'),
            iconFile: document.getElementById('icon-file-input'),
            
            // Buttons
            btnAddLink: document.getElementById('btn-add-link'),
            btnAddFolder: document.getElementById('btn-add-folder'),
            btnEdit: document.getElementById('btn-edit'),
            btnMove: document.getElementById('btn-move'),
            btnDelete: document.getElementById('btn-delete'),
            btnResetIcon: document.getElementById('btn-reset-icon')
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                els.loginStatus.textContent = "Success! Loading data...";
                els.userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;
                els.userName.textContent = user.displayName;
                els.mobileAvatar.src = els.userAvatar.src;
                els.mobileName.textContent = user.displayName;
                els.mobileEmail.textContent = user.email;

                // Migration Check: If firestore empty but localstorage has data
                await checkAndMigrateData(user.uid);

                setupRealtimeListener(user.uid);
                
                // Transition UI
                setTimeout(() => {
                    els.loginOverlay.classList.add('hidden');
                    els.appContainer.classList.remove('hidden');
                    lucide.createIcons();
                }, 500);
            } else {
                currentUser = null;
                localItems = {};
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                els.loginOverlay.classList.remove('hidden');
                els.appContainer.classList.add('hidden');
                els.loginStatus.textContent = "";
            }
        });

        els.googleBtn.onclick = async () => {
            const provider = new GoogleAuthProvider();
            try {
                els.loginStatus.textContent = "Connecting to Google...";
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                els.loginStatus.textContent = "Login failed: " + error.message;
            }
        };

        const handleLogout = () => {
            if(confirm("Sign out?")) signOut(auth);
        };
        els.logoutBtn.onclick = handleLogout;
        els.mobileLogoutBtn.onclick = handleLogout;

        // --- FIRESTORE SYNC ---
        function setupRealtimeListener(uid) {
            const colRef = collection(db, 'users', uid, 'items');
            unsubscribeSnapshot = onSnapshot(colRef, (snapshot) => {
                let changes = false;
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (change.type === "added" || change.type === "modified") {
                        localItems[change.doc.id] = data;
                    }
                    if (change.type === "removed") {
                        delete localItems[change.doc.id];
                    }
                    changes = true;
                });
                
                if (changes) {
                    renderCurrentView();
                }
            }, (error) => {
                console.error("Sync error:", error);
            });
        }

        // --- MIGRATION UTILS ---
        async function checkAndMigrateData(uid) {
            const oldData = localStorage.getItem('bookmarkLibraryItems');
            if (!oldData) return;

            // Check if user already has data in cloud
            const q = query(collection(db, 'users', uid, 'items'), where('parentId', '==', 'root'));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                const doImport = confirm("We found local bookmarks. Would you like to upload them to your account?");
                if (doImport) {
                    els.spinner.classList.remove('hidden');
                    try {
                        const items = JSON.parse(oldData);
                        const batch = writeBatch(db);
                        let count = 0;
                        
                        // Batches are limited to 500
                        const entries = Object.values(items);
                        const chunkArray = (arr, size) => arr.length > size ? [arr.slice(0, size), ...chunkArray(arr.slice(size), size)] : [arr];
                        const chunks = chunkArray(entries, 450);

                        for (const chunk of chunks) {
                            const newBatch = writeBatch(db);
                            chunk.forEach(item => {
                                const docRef = doc(db, 'users', uid, 'items', item.id);
                                newBatch.set(docRef, item);
                            });
                            await newBatch.commit();
                        }
                        
                        localStorage.removeItem('bookmarkLibraryItems'); // Clear local
                        showToast("Migration successful!");
                    } catch (e) {
                        console.error(e);
                        alert("Migration failed: " + e.message);
                    }
                    els.spinner.classList.add('hidden');
                }
            }
        }

        // --- RENDER LOGIC ---
        function getSortedItems(parentId) {
            const items = Object.values(localItems).filter(i => i.parentId === parentId);
            return items.sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        function renderCurrentView() {
            // Verify current folder exists (handling deletion from other device)
            if (currentFolderId !== 'root' && !localItems[currentFolderId]) {
                navigateTo('root');
                return;
            }

            // Breadcrumbs
            els.breadcrumbs.innerHTML = '';
            breadcrumbs.forEach((crumb, idx) => {
                const isLast = idx === breadcrumbs.length - 1;
                const btn = document.createElement('button');
                btn.className = `px-2 py-1 rounded text-sm font-medium transition-colors ${isLast ? 'text-white' : 'text-gray-400 hover:text-white hover:bg-white/10'}`;
                btn.textContent = crumb.name;
                if (!isLast) btn.onclick = () => navigateBack(idx);
                els.breadcrumbs.appendChild(btn);
                
                if (!isLast) {
                    const sep = document.createElement('i');
                    sep.setAttribute('data-lucide', 'chevron-right');
                    sep.className = "w-4 h-4 text-gray-600";
                    els.breadcrumbs.appendChild(sep);
                }
            });

            // Grid
            const items = getSortedItems(currentFolderId);
            els.itemsGrid.innerHTML = '';
            
            if (items.length === 0) {
                els.emptyState.classList.replace('hidden', 'flex');
            } else {
                els.emptyState.classList.replace('flex', 'hidden');
                items.forEach(item => {
                    const el = createItemElement(item);
                    els.itemsGrid.appendChild(el);
                });
            }

            lucide.createIcons();
            initSortable();
        }

        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = `group relative flex flex-col items-center ${item.type === 'folder' ? 'col-span-2 row-span-2' : 'col-span-1 row-span-1'}`;
            div.dataset.id = item.id;

            const innerClass = "w-full aspect-square rounded-2xl bg-gray-800 border border-white/5 shadow-lg overflow-hidden transition-transform active:scale-95 group-hover:border-white/20 relative";
            
            let content = '';
            if (item.type === 'folder') {
                content = `
                    <div class="${innerClass} p-2 grid grid-cols-2 grid-rows-2 gap-1 cursor-pointer" onclick="app.openFolder('${item.id}')">
                        ${renderFolderPreview(item.id)}
                    </div>
                `;
            } else {
                content = `
                    <a href="${item.url}" target="_blank" class="${innerClass} block bg-white">
                        <img src="${item.favicon}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100/222/fff?text=${item.name[0]}'"/>
                    </a>
                `;
            }

            // Option button
            const optBtn = `
                <button onclick="app.openOptions('${item.id}', event)" class="absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-black/80">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                </button>
            `;

            div.innerHTML = content + `<span class="mt-2 text-xs text-center text-gray-300 truncate w-full px-1 select-none">${item.name}</span>` + optBtn;
            return div;
        }

        function renderFolderPreview(folderId) {
            const children = getSortedItems(folderId).slice(0, 4);
            let html = '';
            for (let i=0; i<4; i++) {
                const child = children[i];
                if (child) {
                    if (child.type === 'folder') {
                        html += `<div class="bg-white/10 rounded-md"></div>`;
                    } else {
                        html += `<img src="${child.favicon}" class="w-full h-full object-cover rounded-md bg-gray-900">`;
                    }
                } else {
                    html += `<div class="bg-transparent"></div>`;
                }
            }
            return html;
        }

        // --- NAVIGATION ---
        function navigateTo(folderId) {
            if (folderId === 'root') {
                breadcrumbs = [{ id: 'root', name: 'Home' }];
            } else {
                const folder = localItems[folderId];
                if (folder) breadcrumbs.push({ id: folder.id, name: folder.name });
            }
            currentFolderId = folderId;
            renderCurrentView();
        }

        function navigateBack(index) {
            breadcrumbs = breadcrumbs.slice(0, index + 1);
            currentFolderId = breadcrumbs[breadcrumbs.length - 1].id;
            renderCurrentView();
        }

        window.app = {
            openFolder: (id) => navigateTo(id),
            openOptions: (id, e) => {
                e.stopPropagation();
                e.preventDefault();
                selectedItem = localItems[id];
                openMenu(els.actionMenu, els.actionOverlay);
            }
        };

        // --- CRUD OPERATIONS (Cloud) ---
        async function addItem(name, url, type, iconData) {
            const id = crypto.randomUUID();
            const order = getSortedItems(currentFolderId).length;
            
            let favicon = iconData;
            if (type === 'link' && !favicon) {
                // Fetch default icon
                try {
                    const domain = new URL(url).hostname;
                    favicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
                    // Convert to base64 via proxy to avoid CORs in future reads? 
                    // For simplicity in this version, we store the URL. 
                    // Or we can use the fetchAndEncode helper from original code.
                    const b64 = await fetchIconBase64(favicon);
                    if(b64) favicon = b64;
                } catch(e) {
                    favicon = `https://placehold.co/128/333/fff?text=${name[0]}`;
                }
            }

            const item = {
                id,
                parentId: currentFolderId,
                name,
                type,
                order,
                createdAt: Date.now()
            };

            if (type === 'link') {
                item.url = url.startsWith('http') ? url : `https://${url}`;
                item.favicon = favicon;
            }

            // Optimistic Update (optional, but snapshot handles it fast enough usually)
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'items', id), item);
                showToast("Added");
            } catch (e) {
                alert("Error adding: " + e.message);
            }
        }

        async function updateItem(id, updates) {
            try {
                // Handle Icon update if passed
                if (updates.newIconFile) {
                    updates.favicon = await resizeImage(updates.newIconFile);
                    delete updates.newIconFile;
                } else if (updates.resetIcon && updates.url) {
                     const domain = new URL(updates.url).hostname;
                     const b64 = await fetchIconBase64(`https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                     updates.favicon = b64;
                     delete updates.resetIcon;
                }
                
                await updateDoc(doc(db, 'users', currentUser.uid, 'items', id), updates);
                showToast("Updated");
            } catch(e) {
                alert("Update failed");
            }
        }

        async function deleteItemRecursive(id) {
            if (!confirm("Delete this item?")) return;
            
            const batch = writeBatch(db);
            const toDelete = [id];
            
            // Simple recursive finder
            const findChildren = (pid) => {
                const children = Object.values(localItems).filter(i => i.parentId === pid);
                children.forEach(c => {
                    toDelete.push(c.id);
                    if(c.type === 'folder') findChildren(c.id);
                });
            };
            findChildren(id);

            toDelete.forEach(itemId => {
                batch.delete(doc(db, 'users', currentUser.uid, 'items', itemId));
            });

            try {
                await batch.commit();
                showToast("Deleted");
            } catch(e) {
                alert("Delete failed");
            }
        }

        async function moveItem(itemId, newParentId) {
            if(itemId === newParentId) return;
            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'items', itemId), {
                    parentId: newParentId,
                    order: 9999 // push to end
                });
                showToast("Moved");
            } catch(e) { console.error(e); }
        }

        // --- SORTING ---
        function initSortable() {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(els.itemsGrid, {
                animation: 150,
                delay: 100,
                delayOnTouchOnly: true,
                disabled: isDragLocked,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: async (evt) => {
                    const itemEls = Array.from(els.itemsGrid.children);
                    const batch = writeBatch(db);
                    let changed = false;

                    itemEls.forEach((el, index) => {
                        const id = el.dataset.id;
                        if (localItems[id].order !== index) {
                            const ref = doc(db, 'users', currentUser.uid, 'items', id);
                            batch.update(ref, { order: index });
                            changed = true;
                        }
                    });

                    if (changed) batch.commit();
                }
            });
        }

        // --- UI HELPERS ---
        function openMenu(menu, overlay) {
            overlay.classList.remove('hidden');
            menu.classList.remove('translate-y-full');
        }
        function closeMenu(menu, overlay) {
            menu.classList.add('translate-y-full');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        function showToast(msg) {
            document.getElementById('toast-msg').textContent = msg;
            const t = document.getElementById('toast');
            t.classList.remove('-translate-y-[200%]');
            setTimeout(() => t.classList.add('-translate-y-[200%]'), 2000);
        }

        // --- IMAGE HELPERS ---
        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 128; canvas.height = 128;
                        const ctx = canvas.getContext('2d');
                        
                        // Cover fit
                        const ratio = Math.max(128/img.width, 128/img.height);
                        const w = img.width * ratio;
                        const h = img.height * ratio;
                        ctx.drawImage(img, (128-w)/2, (128-h)/2, w, h);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function fetchIconBase64(url) {
            try {
                const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                const blob = await res.blob();
                return new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch(e) { return null; }
        }

        // --- EVENT BINDINGS ---
        
        // FAB & Menus
        els.fab.onclick = () => openMenu(els.addMenu, els.addOverlay);
        els.addOverlay.onclick = () => closeMenu(els.addMenu, els.addOverlay);
        els.actionOverlay.onclick = () => closeMenu(els.actionMenu, els.actionOverlay);
        els.btnCancelSettings = document.getElementById('btn-cancel-settings');
        els.btnCancelSettings.onclick = () => closeMenu(els.settingsMenu, els.settingsOverlay);
        els.settingsOverlay.onclick = () => closeMenu(els.settingsMenu, els.settingsOverlay);
        
        document.getElementById('btn-cancel-add').onclick = () => closeMenu(els.addMenu, els.addOverlay);
        document.getElementById('btn-cancel-action').onclick = () => closeMenu(els.actionMenu, els.actionOverlay);

        // Mobile Menu
        els.mobileMenuBtn.onclick = () => openMenu(els.settingsMenu, els.settingsOverlay);

        // Add Logic
        const openInput = (mode, type) => {
            els.inputForm.reset();
            els.inputModal.classList.remove('hidden');
            document.getElementById('input-title').textContent = mode === 'add' ? `Add ${type === 'link'?'Link':'Folder'}` : 'Edit Item';
            
            const isLink = type === 'link' || (selectedItem && selectedItem.type === 'link');
            document.getElementById('url-group').style.display = isLink ? 'block' : 'none';
            document.getElementById('icon-group').style.display = isLink ? 'flex' : 'none';
            els.inputPreview.src = '';

            if (mode === 'edit') {
                els.inputName.value = selectedItem.name;
                if(isLink) {
                    els.inputUrl.value = selectedItem.url;
                    els.inputPreview.src = selectedItem.favicon;
                }
            }

            els.inputForm.onsubmit = async (e) => {
                e.preventDefault();
                const name = els.inputName.value;
                const url = els.inputUrl.value;
                const file = els.iconFile.files[0];

                els.inputModal.classList.add('hidden');

                if (mode === 'add') {
                    let icon = null;
                    if(file) icon = await resizeImage(file);
                    addItem(name, url, type, icon);
                } else {
                    const updates = { name };
                    if(isLink) updates.url = url;
                    if(file) updates.newIconFile = file;
                    updateItem(selectedItem.id, updates);
                }
            };
        };

        els.btnAddLink.onclick = () => { closeMenu(els.addMenu, els.addOverlay); openInput('add', 'link'); };
        els.btnAddFolder.onclick = () => { closeMenu(els.addMenu, els.addOverlay); openInput('add', 'folder'); };
        document.getElementById('btn-cancel-input').onclick = () => els.inputModal.classList.add('hidden');

        // Edit/Delete
        els.btnEdit.onclick = () => { closeMenu(els.actionMenu, els.actionOverlay); openInput('edit'); };
        els.btnDelete.onclick = () => { closeMenu(els.actionMenu, els.actionOverlay); deleteItemRecursive(selectedItem.id); };

        // Move
        els.btnMove.onclick = () => {
            closeMenu(els.actionMenu, els.actionOverlay);
            moveTargetId = 'root';
            moveCrumbPath = [{id:'root', name:'Home'}];
            renderMoveUI();
            els.moveModal.classList.remove('hidden');
        };
        document.getElementById('btn-cancel-move').onclick = () => els.moveModal.classList.add('hidden');
        document.getElementById('btn-confirm-move').onclick = () => {
            moveItem(selectedItem.id, moveTargetId);
            els.moveModal.classList.add('hidden');
        };

        function renderMoveUI() {
            // Breadcrumbs
            const crumbsDiv = document.getElementById('move-breadcrumbs');
            crumbsDiv.innerHTML = '';
            moveCrumbPath.forEach((c, i) => {
                const s = document.createElement('span');
                s.textContent = c.name + (i < moveCrumbPath.length-1 ? ' > ' : '');
                s.className = "cursor-pointer hover:text-white";
                s.onclick = () => {
                    moveTargetId = c.id;
                    moveCrumbPath = moveCrumbPath.slice(0, i+1);
                    renderMoveUI();
                };
                crumbsDiv.appendChild(s);
            });

            // List
            const list = document.getElementById('move-list');
            list.innerHTML = '';
            const folders = Object.values(localItems)
                .filter(i => i.parentId === moveTargetId && i.type === 'folder' && i.id !== selectedItem.id);
            
            if(folders.length === 0) list.innerHTML = '<p class="text-gray-500 text-center py-4">No subfolders</p>';
            
            folders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 hover:bg-white/5 rounded text-gray-300 flex items-center gap-2";
                btn.innerHTML = `<i data-lucide="folder" class="w-4 h-4"></i> ${f.name}`;
                btn.onclick = () => {
                    moveTargetId = f.id;
                    moveCrumbPath.push({id: f.id, name: f.name});
                    renderMoveUI();
                };
                list.appendChild(btn);
            });
            lucide.createIcons();
        }

        // Icon Inputs
        document.getElementById('icon-preview-click').onclick = () => els.iconFile.click();
        els.iconFile.onchange = async (e) => {
            if(e.target.files[0]) {
                const b64 = await resizeImage(e.target.files[0]);
                els.inputPreview.src = b64;
            }
        };
        els.inputUrl.onblur = () => {
            if(els.inputUrl.value && !els.iconFile.files.length && !els.inputPreview.src.includes('data:')) {
                const d = new URL(els.inputUrl.value).hostname;
                els.inputPreview.src = `https://www.google.com/s2/favicons?domain=${d}&sz=128`;
            }
        };

        // Lock
        const toggleLock = () => {
            isDragLocked = !isDragLocked;
            const icon = isDragLocked ? 'lock' : 'unlock';
            els.desktopLock.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
            els.mobileLock.querySelector('span').textContent = isDragLocked ? 'Unlock Dragging' : 'Lock Dragging';
            els.mobileLock.querySelector('i').setAttribute('data-lucide', icon);
            lucide.createIcons();
            initSortable();
        };
        els.desktopLock.onclick = toggleLock;
        els.mobileLock.onclick = toggleLock;

    </script>
</body>
</html>
