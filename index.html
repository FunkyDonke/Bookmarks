<!DOCTYPE html>
<!-- 'dark' class is now permanent -->
<html lang="en" class="dark"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Bookmark Library</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (jsDelivr CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.379.0/dist/umd/lucide.min.js" id="lucide-script"></script>
    
    <!-- SortableJS for Drag-and-Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1c1e;
            background-image: radial-gradient(circle at top center, #4a4a4f 0%, #1c1c1e 70%);
        }

        /* Custom scrollbar */
        .folder-list::-webkit-scrollbar { width: 6px; }
        .folder-list::-webkit-scrollbar-track { background: #2c2c2e; }
        .folder-list::-webkit-scrollbar-thumb { background: #4a4a4f; border-radius: 10px; }
        
        #breadcrumbs-container::-webkit-scrollbar { height: 2px; }
        #breadcrumbs-container::-webkit-scrollbar-track { background: transparent; }
        #breadcrumbs-container::-webkit-scrollbar-thumb { background: #4a4a4f; border-radius: 2px; }

        #move-breadcrumbs::-webkit-scrollbar { height: 2px; }
        #move-breadcrumbs::-webkit-scrollbar-track { background: transparent; }
        #move-breadcrumbs::-webkit-scrollbar-thumb { background: #4a4a4f; border-radius: 2px; }

        /* Glassmorphism effect */
        .backdrop-blur-xl { backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); }
        
        /* Animations */
        .animate-sheet-up { animation: sheet-up 0.3s cubic-bezier(0.32, 0.72, 0, 1) forwards; }
        @keyframes sheet-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-modal-in { animation: modal-in 0.2s ease-out forwards; }
        @keyframes modal-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* SortableJS */
        .sortable-ghost { opacity: 0.3; transform: scale(0.95); }
        .sortable-chosen { cursor: grabbing; }

        .visually-hidden-file-input {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* Login Overlay */
        #login-overlay {
            background-color: #1c1c1e;
            background-image: radial-gradient(circle at top center, #2c2c30 0%, #1c1c1e 80%);
        }
    </style>
</head>
<body class="text-white overflow-hidden h-screen select-none">

    <!-- ===== LOGIN OVERLAY (NEW) ===== -->
    <div id="login-overlay" class="fixed inset-0 z-[2000] flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8 p-6 bg-white/5 rounded-3xl backdrop-blur-xl border border-white/10 shadow-2xl">
            <i data-lucide="cloud" class="w-20 h-20 text-blue-500"></i>
        </div>
        <h1 class="text-4xl font-bold mb-3 tracking-tight">Cloud Library</h1>
        <p class="text-gray-400 mb-10 max-w-md text-lg">Sync your bookmarks seamlessly across all your devices.</p>
        
        <button id="google-signin-btn" class="flex items-center gap-3 bg-white text-gray-900 px-8 py-4 rounded-2xl font-bold text-lg hover:bg-gray-100 transition-transform active:scale-95 shadow-xl shadow-white/5">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
            Sign in with Google
        </button>
        <p id="login-status" class="mt-6 text-sm text-gray-500 font-medium h-5 animate-pulse"></p>
    </div>

    <!-- ===== Global Loading Spinner ===== -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-900/50 backdrop-blur-md z-[999] flex items-center justify-center hidden">
        <div class="flex flex-col items-center gap-4">
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-300 text-lg font-medium" id="auth-status">Syncing Data...</p>
        </div>
    </div>

    <!-- ===== Main App Container ===== -->
    <div id="app-container" class="h-screen w-screen flex flex-col hidden">
        
        <!-- ===== COMPACT HEADER ===== -->
        <header class="sticky top-0 z-30 px-4 sm:px-6 md:px-8 bg-black/30 backdrop-blur-lg border-b border-white/5">
            <div class="flex justify-between items-center pt-6 pb-3"> 
                <!-- Breadcrumbs -->
                <nav id="breadcrumbs-container" class="flex-1 flex items-center space-x-1 overflow-x-auto whitespace-nowrap">
                    <!-- Breadcrumbs will be injected here -->
                </nav>
                <!-- Desktop Buttons (hidden on mobile) -->
                <div class="hidden sm:flex items-center space-x-2 ml-4">
                    <!-- User Profile Badge -->
                    <div class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-lg mr-2 border border-white/5">
                        <img id="header-avatar" src="" class="w-5 h-5 rounded-full">
                        <span id="header-username" class="text-xs font-medium text-gray-300 max-w-[100px] truncate">User</span>
                    </div>

                    <button id="import-button" class="px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors font-medium text-sm flex-shrink-0">
                        Import
                    </button>
                    <button id="export-button" class="px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors font-medium text-sm flex-shrink-0">
                        Export
                    </button>
                    <button id="drag-lock-button" class="px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors font-medium text-sm flex-shrink-0">
                        Unlock
                    </button>
                    <button id="logout-button" class="px-3 py-2 rounded-lg text-red-400 hover:bg-red-500 hover:text-white transition-colors font-medium text-sm flex-shrink-0">
                        Sign Out
                    </button>
                </div>
                <!-- Mobile "Settings" Button (hidden on desktop) -->
                <div class="flex sm:hidden items-center ml-4">
                     <button id="mobile-settings-button" class="px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors font-medium text-sm flex-shrink-0">
                        Menu
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="flex-1 overflow-y-auto px-4 sm:px-6 md:px-8 pt-4 pb-32">
            <div id="items-grid" class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-4" style="grid-auto-rows: minmax(min-content, max-content);">
                <!-- Items will be injected here -->
            </div>
            <div id="empty-folder-message" class="hidden flex-col items-center justify-center h-full text-gray-500 -mt-16">
                <i data-lucide="folder-open" class="w-16 h-16 mb-4"></i>
                <h2 class="text-xl font-semibold text-white">Empty Folder</h2>
                <p class="text-gray-400">Add a new link or folder to get started.</p>
            </div>
        </main>

        <!-- Footer / Add Button -->
        <footer class="p-4">
            <button id="add-button" class="fixed bottom-8 right-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-4 shadow-lg transition-transform active:scale-90 z-40">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </footer>

    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept="application/json" class="visually-hidden-file-input">

    <!-- ===== MODALS & OVERLAYS ===== -->

    <!-- Add Item Bottom Sheet -->
    <div id="add-menu-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"></div>
    <div id="add-menu" class="fixed bottom-0 left-0 right-0 z-50 p-4 transform translate-y-full transition-transform">
        <div class="animate-sheet-up space-y-3">
            <div class="bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl">
                <button id="add-link-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-white/10">Add New Link</button>
                <button id="add-folder-button" class="w-full text-left p-4 text-blue-400 text-lg">Add New Folder</button>
            </div>
            <button id="cancel-add-menu" class="w-full p-4 bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl text-lg text-blue-400 font-semibold">Cancel</button>
        </div>
    </div>

    <!-- Action Bottom Sheet (Edit, Move, Delete) -->
    <div id="action-menu-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"></div>
    <div id="action-menu" class="fixed bottom-0 left-0 right-0 z-50 p-4 transform translate-y-full transition-transform">
        <div class="animate-sheet-up space-y-3">
            <div class="bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl">
                <button id="edit-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-black/10 dark:border-white/10">Edit</button>
                <button id="move-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-black/10 dark:border-white/10">Move</button>
                <button id="delete-button" class="w-full text-left p-4 text-red-500 text-lg">Delete</button>
            </div>
            <button id="cancel-action-menu" class="w-full p-4 bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl text-lg text-blue-400 font-semibold">Cancel</button>
        </div>
    </div>
    
    <!-- Mobile Settings Bottom Sheet -->
    <div id="mobile-settings-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"></div>
    <div id="mobile-settings-menu" class="fixed bottom-0 left-0 right-0 z-50 p-4 transform translate-y-full transition-transform">
        <div class="animate-sheet-up space-y-3">
            <div class="bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl">
                <!-- Profile Section Mobile -->
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <img id="mobile-menu-avatar" src="" class="w-10 h-10 rounded-full border border-white/10">
                    <div class="overflow-hidden">
                        <p id="mobile-menu-username" class="text-white font-medium truncate">User</p>
                        <p id="mobile-menu-email" class="text-xs text-gray-400 truncate">email@example.com</p>
                    </div>
                </div>

                <button id="mobile-import-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-black/10 dark:border-white/10">Import Bookmarks</button>
                <button id="mobile-export-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-black/10 dark:border-white/10">Export Bookmarks</button>
                <button id="mobile-drag-lock-button" class="w-full text-left p-4 text-blue-400 text-lg border-b border-black/10 dark:border-white/10">Unlock</button>
                <button id="mobile-logout-button" class="w-full text-left p-4 text-red-500 text-lg">Sign Out</button>
            </div>
            <button id="cancel-mobile-settings-menu" class="w-full p-4 bg-gray-700/70 backdrop-blur-2xl border border-white/5 rounded-xl text-lg text-blue-400 font-semibold">Cancel</button>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="delete-modal-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-xl z-50 flex items-center justify-center p-4 hidden animate-modal-in">
        <div class="bg-gray-800/80 backdrop-blur-2xl border border-white/10 rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h2 id="delete-modal-title" class="text-xl font-semibold mb-2 text-white">Are you sure?</h2>
            <p id="delete-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete-modal" class="py-2 px-4 bg-gray-600 text-gray-100 hover:bg-gray-500 rounded-md transition-colors">Cancel</button>
                <button type="button" id="confirm-delete-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors font-medium">Delete</button>
            </div>
        </div>
    </div>

    <!-- Input Modal (for Add/Edit) -->
    <div id="input-modal-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-xl z-50 flex items-center justify-center p-4 hidden animate-modal-in">
        <div class="bg-gray-800/80 backdrop-blur-2xl border border-white/10 rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h2 id="input-modal-title" class="text-xl font-semibold mb-4 text-white">Modal Title</h2>
            <form id="input-form">
                <div class="space-y-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                        <input type="text" id="item-name" class="w-full bg-gray-700 text-white rounded-md p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div id="url-input-group">
                        <label for="item-url" class="block text-sm font-medium text-gray-300 mb-1">URL</label>
                        <input type="url" id="item-url" placeholder="https://example.com" class="w-full bg-gray-700 text-white rounded-md p-3 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <!-- "Upload Custom Icon" field -->
                    <div id="icon-upload-group" style="display: none;">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-300">Custom Icon</label>
                            <button type="button" id="reset-icon-button" class="text-sm text-red-400 hover:text-red-500 transition-colors">Reset to Default</button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="item-icon-upload" class="flex-1 w-full text-center py-2 px-4 bg-gray-600 text-gray-100 hover:bg-gray-500 rounded-md transition-colors cursor-pointer">
                                Upload Icon
                            </label>
                            <input type="file" id="item-icon-upload" accept="image/*" class="visually-hidden-file-input">
                            <img id="icon-upload-preview" src="" alt="Icon Preview" class="w-10 h-10 rounded-lg hidden object-cover">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Or paste an Icon URL below:</p>
                        <input type="url" id="item-icon-url" placeholder="https://example.com/icon.png" class="w-full bg-gray-700 text-white rounded-md p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none mt-1">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-input-modal" class="py-2 px-4 bg-gray-600 text-gray-100 hover:bg-gray-500 rounded-md transition-colors">Cancel</button>
                    <button type="submit" id="confirm-input-modal" class="py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors font-medium">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Move Modal -->
    <div id="move-modal-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-xl z-50 flex items-center justify-center p-4 hidden animate-modal-in">
        <div class="bg-gray-800/80 backdrop-blur-2xl border border-white/10 rounded-xl p-6 w-full max-w-sm shadow-2xl flex flex-col" style="height: 70vh; max-height: 500px;">
            <h2 class="text-xl font-semibold mb-4 text-white">Move to...</h2>
            <div id="move-breadcrumbs" class="flex items-center space-x-1 overflow-x-auto whitespace-nowrap pb-3 border-b border-gray-700 mb-3">
                <!-- Move breadcrumbs injected here -->
            </div>
            <div id="move-folder-list" class="flex-1 overflow-y-auto folder-list -mr-2 pr-2">
                <!-- Folder list will be injected here -->
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="cancel-move-modal" class="py-2 px-4 bg-gray-600 text-gray-100 hover:bg-gray-500 rounded-md transition-colors">Cancel</button>
                <button type="button" id="confirm-move-button" class="py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors font-medium">Move Here</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-20 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[200%] transition-transform duration-300 ease-out z-[999]">
        <p id="notification-message">Success!</p>
    </div>

    <!-- MAIN APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, writeBatch, enableIndexedDbPersistence, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8Bsa_MPuz_2BtlC-k4pwyvEOFxcIIfKs",
            authDomain: "my-bookmark-app-1fe39.firebaseapp.com",
            projectId: "my-bookmark-app-1fe39",
            storageBucket: "my-bookmark-app-1fe39.firebasestorage.app",
            messagingSenderId: "1014980538022",
            appId: "1:1014980538022:web:810f2eae78c2423271ce67"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable Offline Support
        enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));

        // --- STATE ---
        // Instead of localStorage, we keep an in-memory cache of the Firestore data
        let localCache = {}; 
        let currentUser = null;
        let unsubscribeSnapshot = null;
        
        // App State
        let currentFolderId = "root";
        let breadcrumbs = [{ id: "root", name: "Home" }];
        let lucideLoaded = false;
        let isDragLocked = true; 
        let selectedItem = { id: null, parentId: null, name: null, url: null, type: null, favicon: null };
        let moveModalTargetFolderId = "root";
        let moveModalBreadcrumbs = [{ id: "root", name: "Home" }];
        
        window.sortableInstance = null;

        // --- DOM Elements ---
        const els = {
            loginOverlay: document.getElementById('login-overlay'),
            googleBtn: document.getElementById('google-signin-btn'),
            loginStatus: document.getElementById('login-status'),
            appContainer: document.getElementById('app-container'),
            loadingSpinner: document.getElementById('loading-spinner'),
            headerAvatar: document.getElementById('header-avatar'),
            headerUsername: document.getElementById('header-username'),
            logoutBtn: document.getElementById('logout-button'),
            mobileLogoutBtn: document.getElementById('mobile-logout-button'),
            mobileAvatar: document.getElementById('mobile-menu-avatar'),
            mobileUsername: document.getElementById('mobile-menu-username'),
            mobileEmail: document.getElementById('mobile-menu-email'),
            
            // Core App
            breadcrumbsContainer: document.getElementById('breadcrumbs-container'),
            itemsGrid: document.getElementById('items-grid'),
            emptyFolderMessage: document.getElementById('empty-folder-message'),
            addButton: document.getElementById('add-button'),
            dragLockButton: document.getElementById('drag-lock-button'),
            
            // Menus & Modals
            mobileSettingsButton: document.getElementById('mobile-settings-button'),
            mobileSettingsOverlay: document.getElementById('mobile-settings-overlay'),
            mobileSettingsMenu: document.getElementById('mobile-settings-menu'),
            cancelMobileSettingsMenu: document.getElementById('cancel-mobile-settings-menu'),
            
            addMenuOverlay: document.getElementById('add-menu-overlay'),
            addMenu: document.getElementById('add-menu'),
            cancelAddMenu: document.getElementById('cancel-add-menu'),
            addLinkButton: document.getElementById('add-link-button'),
            addFolderButton: document.getElementById('add-folder-button'),
            
            actionMenuOverlay: document.getElementById('action-menu-overlay'),
            actionMenu: document.getElementById('action-menu'),
            cancelActionMenu: document.getElementById('cancel-action-menu'),
            editButton: document.getElementById('edit-button'), 
            moveButton: document.getElementById('move-button'),
            deleteButton: document.getElementById('delete-button'),
            
            inputModalOverlay: document.getElementById('input-modal-overlay'),
            inputModalTitle: document.getElementById('input-modal-title'),
            inputForm: document.getElementById('input-form'),
            urlInputGroup: document.getElementById('url-input-group'),
            itemNameInput: document.getElementById('item-name'),
            itemUrlInput: document.getElementById('item-url'),
            iconUploadGroup: document.getElementById('icon-upload-group'),
            itemIconUrlInput: document.getElementById('item-icon-url'),
            itemIconUploadInput: document.getElementById('item-icon-upload'),
            iconUploadPreview: document.getElementById('icon-upload-preview'),
            resetIconButton: document.getElementById('reset-icon-button'),
            cancelInputModal: document.getElementById('cancel-input-modal'),
            
            deleteModalOverlay: document.getElementById('delete-modal-overlay'),
            deleteModalTitle: document.getElementById('delete-modal-title'),
            deleteModalText: document.getElementById('delete-modal-text'),
            cancelDeleteModal: document.getElementById('cancel-delete-modal'),
            confirmDeleteButton: document.getElementById('confirm-delete-button'),
            
            moveModalOverlay: document.getElementById('move-modal-overlay'),
            moveBreadcrumbs: document.getElementById('move-breadcrumbs'),
            moveFolderList: document.getElementById('move-folder-list'),
            cancelMoveModal: document.getElementById('cancel-move-modal'),
            confirmMoveButton: document.getElementById('confirm-move-button'),
            
            importFileInput: document.getElementById('import-file-input'),
            importButton: document.getElementById('import-button'),
            exportButton: document.getElementById('export-button'),
            mobileImportButton: document.getElementById('mobile-import-button'),
            mobileExportButton: document.getElementById('mobile-export-button'),
            mobileDragLockButton: document.getElementById('mobile-drag-lock-button'),

            notificationToast: document.getElementById('notification-toast'),
            notificationMessage: document.getElementById('notification-message')
        };

        // --- AUTHENTICATION FLOW ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                els.loginStatus.textContent = "Welcome back!";
                updateUserProfile(user);
                
                // Hide Login, Show Spinner
                els.loginOverlay.classList.add('hidden');
                els.loadingSpinner.classList.remove('hidden');

                // 1. Check for local migration need
                await checkAndMigrateData(user.uid);

                // 2. Start Listening to Firestore
                setupRealtimeListener(user.uid);
            } else {
                // Show Login
                currentUser = null;
                localCache = {};
                if(unsubscribeSnapshot) unsubscribeSnapshot();
                els.loginOverlay.classList.remove('hidden');
                els.appContainer.classList.add('hidden');
                els.loadingSpinner.classList.add('hidden');
                els.loginStatus.textContent = "";
            }
        });

        els.googleBtn.onclick = async () => {
            const provider = new GoogleAuthProvider();
            try {
                els.loginStatus.textContent = "Connecting...";
                await signInWithPopup(auth, provider);
            } catch (e) {
                els.loginStatus.textContent = "Error: " + e.message;
            }
        };

        const handleLogout = () => { if(confirm("Sign out?")) signOut(auth); };
        els.logoutBtn.onclick = handleLogout;
        els.mobileLogoutBtn.onclick = handleLogout;

        function updateUserProfile(user) {
            const avatar = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;
            els.headerAvatar.src = avatar;
            els.headerUsername.textContent = user.displayName;
            els.mobileAvatar.src = avatar;
            els.mobileUsername.textContent = user.displayName;
            els.mobileEmail.textContent = user.email;
        }

        // --- FIRESTORE SYNC & MIGRATION ---
        
        async function checkAndMigrateData(uid) {
            const oldData = localStorage.getItem('bookmarkLibraryItems');
            if (!oldData) return;

            // Check if user has ANY data in cloud
            const q = query(collection(db, 'users', uid, 'items'), where('parentId', '==', 'root'));
            const snap = await getDocs(q);

            if (snap.empty) {
                const doImport = confirm("We found local bookmarks on this device. Upload them to the cloud?");
                if (doImport) {
                    try {
                        const items = JSON.parse(oldData);
                        const batch = writeBatch(db);
                        const entries = Object.values(items);
                        
                        // Batches max 500 ops
                        const chunks = [];
                        for (let i = 0; i < entries.length; i += 450) {
                            chunks.push(entries.slice(i, i + 450));
                        }

                        for (const chunk of chunks) {
                            const newBatch = writeBatch(db);
                            chunk.forEach(item => {
                                const docRef = doc(db, 'users', uid, 'items', item.id);
                                newBatch.set(docRef, item);
                            });
                            await newBatch.commit();
                        }
                        
                        localStorage.removeItem('bookmarkLibraryItems'); 
                        showNotification("Migration successful!");
                    } catch (e) {
                        console.error("Migration failed", e);
                        alert("Migration failed: " + e.message);
                    }
                }
            }
        }

        function setupRealtimeListener(uid) {
            const colRef = collection(db, 'users', uid, 'items');
            unsubscribeSnapshot = onSnapshot(colRef, (snapshot) => {
                let hasChanges = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        localCache[change.doc.id] = change.doc.data();
                    }
                    if (change.type === "removed") {
                        delete localCache[change.doc.id];
                    }
                    hasChanges = true;
                });

                if (hasChanges || snapshot.size === 0) {
                    // Update UI Cache logic for folders
                    updateAllFolderPreviews(); 
                    // Refresh View
                    navigateToFolder(currentFolderId);
                    
                    els.loadingSpinner.classList.add('hidden');
                    els.appContainer.classList.remove('hidden');
                }
            });
        }

        // --- CORE LOGIC (Adapted from Original) ---
        
        function getAllItems() { return localCache; } // Replaces localstorage read
        function getItems(parentId) {
            const items = Object.values(localCache).filter(item => item.parentId === parentId);
            items.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
            return items;
        }

        function updateAllFolderPreviews() {
            // Recalculate previews logic strictly in memory for rendering? 
            // Or save back to DB? 
            // To save DB writes, we will compute previews on the fly during render, 
            // OR we iterate and update DB if we want persistence. 
            // For now, let's replicate the original logic which saved to DB.
            // But doing this on every snapshot might cause write loops.
            // BETTER STRATEGY: Compute previews dynamically in `renderItems` instead of storing them.
        }

        // --- CRUD OPERATIONS (Cloud Enabled) ---

        async function addItem(type, name, url = null, customIconFile = null, importedFavicon = null) {
            let fullUrl = url;
            if (type === 'link' && url) {
                if (!fullUrl.startsWith('http')) fullUrl = 'https://' + fullUrl;
                if (!name) {
                     try {
                        let h = new URL(fullUrl).hostname.replace(/^www\./, '');
                        let gn = h.split('.')[0];
                        name = gn.charAt(0).toUpperCase() + gn.slice(1);
                    } catch (e) { name = "Untitled Link"; }
                }
            }

            const currentItems = getItems(currentFolderId);
            const newItem = {
                id: crypto.randomUUID(), 
                name: name, 
                type: type, 
                parentId: currentFolderId,
                createdAt: new Date().toISOString(), 
                order: currentItems.length
            };

            if (type === 'link') {
                if (!url) { showNotification("URL is required", true); return null; }
                newItem.url = fullUrl;
                
                if (importedFavicon) { 
                    newItem.favicon = importedFavicon;
                } else if (customIconFile) { 
                    newItem.favicon = await resizeAndEncode(customIconFile);
                } else { 
                    const iconUrl = `https://www.google.com/s2/favicons?domain=${getDomainFromUrl(fullUrl)}&sz=128`;
                    newItem.favicon = await fetchAndEncodeIcon(iconUrl); 
                }
            } else {
                newItem.previewItems = [];
            }

            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'items', newItem.id), newItem);
                showNotification(`${type === 'link' ? 'Link' : 'Folder'} added!`);
                return newItem.id;
            } catch (e) {
                console.error(e);
                showNotification("Error saving to cloud", true);
            }
        }

        async function editItem(itemId, newName, newUrl, newIconUrl, newIconFile) {
            const item = localCache[itemId];
            if (!item) return;
            
            const updates = { name: newName };
            
            if (item.type === 'link') {
                let fullUrl = newUrl;
                if (newUrl && !fullUrl.startsWith('http')) fullUrl = 'https://' + fullUrl;
                updates.url = fullUrl;

                if (newIconFile) {
                    updates.favicon = await resizeAndEncode(newIconFile);
                } else if (newIconUrl && newIconUrl.startsWith('http')) {
                    updates.favicon = await fetchAndEncodeIcon(newIconUrl);
                } else if (newIconUrl === "") {
                    // Reset
                    const d = getDomainFromUrl(fullUrl || item.url);
                    updates.favicon = await fetchAndEncodeIcon(`https://www.google.com/s2/favicons?domain=${d}&sz=128`);
                }
            }

            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'items', itemId), updates);
                showNotification("Updated!");
            } catch (e) {
                showNotification("Update failed", true);
            }
        }

        async function moveItem(itemId, newParentId) {
            if (itemId === newParentId) return;
             try {
                // Get new parent's item count for order
                const siblings = Object.values(localCache).filter(i => i.parentId === newParentId);
                await updateDoc(doc(db, 'users', currentUser.uid, 'items', itemId), {
                    parentId: newParentId,
                    order: siblings.length
                });
                showNotification("Moved!");
            } catch(e) { showNotification("Move failed", true); }
        }

        async function deleteItem(itemId) {
            try {
                // Recursive delete
                const batch = writeBatch(db);
                const toDelete = [itemId];
                
                const findChildren = (pid) => {
                    const children = Object.values(localCache).filter(i => i.parentId === pid);
                    children.forEach(c => {
                        toDelete.push(c.id);
                        if(c.type === 'folder') findChildren(c.id);
                    });
                };
                findChildren(itemId);

                toDelete.forEach(id => {
                    batch.delete(doc(db, 'users', currentUser.uid, 'items', id));
                });

                await batch.commit();
                showNotification("Deleted!");
            } catch(e) { showNotification("Delete failed", true); }
        }

        // --- UI RENDERING (Restored from Original) ---
        
        function renderItems(items) {
            els.itemsGrid.innerHTML = '';
            if (items.length === 0) {
                els.emptyFolderMessage.classList.remove('hidden');
                els.emptyFolderMessage.classList.add('flex');
            } else {
                els.emptyFolderMessage.classList.add('hidden');
                els.emptyFolderMessage.classList.remove('flex');
            }

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.dataset.id = item.id;
                itemEl.className = "flex flex-col items-center group relative cursor-grab active:cursor-grabbing"; 
                const iconWrapper = document.createElement('div');
                iconWrapper.className = "w-full aspect-square relative"; 
                const wrapper = document.createElement('div');
                wrapper.className = "w-full h-full"; 
                const fallbackChar = item.name.charAt(0).toUpperCase() || '?';
                const darkPlaceholder = `https://placehold.co/128/374151/9CA3AF?text=${fallbackChar}&font=inter`;

                if (item.type === 'link') {
                    itemEl.classList.add('col-span-1', 'row-span-1');
                    wrapper.innerHTML = `
                        <a href="${item.url}" target="_blank" class="w-full h-full flex items-center justify-center transition-transform active:scale-95 group-hover:scale-105" draggable="false" onclick="event.preventDefault();">
                            <img src="${item.favicon || ''}" alt="${item.name}" class="w-full h-full object-cover rounded-2xl shadow-md" onerror="this.src='${darkPlaceholder}'" draggable="false">
                        </a>`;
                    wrapper.querySelector('a').onclick = (e) => {
                        if (e.target.closest('.sortable-chosen')) { e.preventDefault(); return; }
                        window.open(item.url, '_blank');
                    };
                } else {
                    itemEl.classList.add('col-span-2', 'row-span-2');
                    // Dynamic Preview Calculation (Instead of stored)
                    const children = Object.values(localCache).filter(i => i.parentId === item.id).sort((a,b)=> (a.order||0)-(b.order||0));
                    const previewHTML = renderFolderPreviewDynamically(children, item.name);
                    
                    wrapper.innerHTML = `
                        <button class="folder-button w-full h-full bg-white/10 backdrop-blur-lg border border-white/5 rounded-3xl p-2 shadow-md transition-transform active:scale-95 group-hover:scale-105" draggable="false">
                            ${previewHTML}
                        </button>`;
                    wrapper.querySelector('.folder-button').onclick = (e) => {
                        if (e.target.closest('.sortable-chosen')) { e.preventDefault(); return; }
                        navigateToFolder(item.id);
                    };
                }

                const optionsButton = document.createElement('button');
                optionsButton.className = "absolute top-0 right-0 bg-black/20 backdrop-blur-md border border-white/10 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-all focus:opacity-100 active:scale-90 z-10";
                optionsButton.innerHTML = renderIcon('more-horizontal', 'w-4 h-4');
                optionsButton.onclick = (e) => {
                    e.stopPropagation();
                    selectedItem = item;
                    openActionMenu();
                };
                iconWrapper.appendChild(wrapper); 
                iconWrapper.appendChild(optionsButton); 
                itemEl.appendChild(iconWrapper); 
                const nameParagraph = document.createElement('p');
                nameParagraph.className = "text-center text-xs text-gray-200 mt-1.5 truncate w-full";
                nameParagraph.textContent = item.name;
                itemEl.appendChild(nameParagraph);
                els.itemsGrid.appendChild(itemEl);
            });

            if (lucideLoaded) lucide.createIcons();
        }

        function renderFolderPreviewDynamically(children, folderName) {
            const fallbackChar = folderName.charAt(0).toUpperCase() || 'F';
            const darkSmallPlaceholder = `https://placehold.co/64/374151/9CA3AF?text=${fallbackChar}&font=inter`;
            
            // Limit to 4 items for grid
            const previewItems = children.slice(0, 4);
            
            let gridItems = '';
            for (let i = 0; i < 4; i++) {
                const item = previewItems[i];
                if (item) {
                    if (item.type === 'folder') {
                        // Recursively get sub-children for the tiny preview
                        const subChildren = Object.values(localCache).filter(x => x.parentId === item.id).sort((a,b)=>(a.order||0)-(b.order||0));
                        gridItems += `
                            <div class="w-full h-full bg-white/5 rounded-lg p-0.5">
                                ${renderFolderPreviewDynamically(subChildren, 'S').replace('gap-1.5', 'gap-0.5')}
                            </div>`;
                    } else {
                        gridItems += `<img src="${item.favicon || ''}" class="w-full h-full object-cover rounded-lg" onerror="this.src='${darkSmallPlaceholder}'">`;
                    }
                } else {
                    gridItems += `<div class="w-full h-full bg-white/5 rounded-lg"></div>`;
                }
            }
            return `<div class="w-full h-full grid grid-cols-2 grid-rows-2 gap-1.5">${gridItems}</div>`;
        }

        function navigateToFolder(folderId, breadcrumbIndex = -1) {
            if (breadcrumbIndex > -1) {
                breadcrumbs = breadcrumbs.slice(0, breadcrumbIndex + 1);
            } else if (folderId !== currentFolderId && folderId !== 'root') {
                const folder = localCache[folderId];
                if(folder) {
                    breadcrumbs.push({ id: folderId, name: folder.name });
                } else {
                    folderId = "root"; 
                    breadcrumbs = [{ id: "root", name: "Home" }];
                }
            } else if (folderId === 'root') {
                breadcrumbs = [{ id: "root", name: "Home" }];
            }
            currentFolderId = folderId;
            
            renderBreadcrumbs();
            
            const items = getItems(currentFolderId);
            renderItems(items);

            // Re-init Sortable
            if (window.sortableInstance) window.sortableInstance.destroy();
            window.sortableInstance = new Sortable(els.itemsGrid, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                disabled: isDragLocked,
                onEnd: async (evt) => {
                    if(evt.oldIndex === evt.newIndex) return;
                    const newOrderIds = Array.from(evt.to.children).map(el => el.dataset.id);
                    const batch = writeBatch(db);
                    newOrderIds.forEach((id, index) => {
                        const ref = doc(db, 'users', currentUser.uid, 'items', id);
                        batch.update(ref, { order: index });
                    });
                    await batch.commit();
                }
            });
        }

        function renderBreadcrumbs() {
            els.breadcrumbsContainer.innerHTML = '';
            breadcrumbs.forEach((crumb, index) => {
                const isLast = index === breadcrumbs.length - 1;
                const crumbEl = document.createElement('div');
                crumbEl.className = `flex items-center space-x-1`;
                const button = document.createElement('button');
                button.textContent = crumb.name;
                button.className = `text-lg font-medium rounded-md px-2 py-1 transition-colors ${isLast ? 'text-white' : 'text-gray-400 hover:bg-gray-700/50 hover:text-gray-200'}`;
                if (!isLast) {
                    button.onclick = () => navigateToFolder(crumb.id, index);
                }
                crumbEl.appendChild(button);
                if (!isLast) {
                    const separator = document.createElement('span');
                    separator.className = "text-gray-500 text-lg";
                    separator.innerHTML = renderIcon('chevron-right', 'w-5 h-5');
                    crumbEl.appendChild(separator);
                }
                els.breadcrumbsContainer.appendChild(crumbEl);
            });
            if (lucideLoaded) lucide.createIcons();
            els.breadcrumbsContainer.scrollLeft = els.breadcrumbsContainer.scrollWidth;
        }

        // --- UTILS (Helpers) ---
        
        function renderIcon(name, classList = "w-6 h-6") {
            if (!lucideLoaded || typeof lucide === 'undefined' || !lucide.icons[name]) {
                return `<div class="${classList} text-gray-400">...</div>`;
            }
            const icon = lucide.icons[name];
            const [tag, attrs, children] = icon;
            return `<svg xmlns="http://www.w3.org/2000/svg" class="${classList}" ${Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ')}>${children.map(([t, a]) => `<${t} ${Object.entries(a).map(([k, v]) => `${k}="${v}"`).join(' ')} />`).join('')}</svg>`;
        }

        function getDomainFromUrl(url) {
            try { return new URL(url).hostname.replace(/^www\./, ''); } catch (e) { return "example.com"; }
        }

        function resizeAndEncode(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 128; canvas.height = 128;
                        const ctx = canvas.getContext('2d');
                        
                        const ratio = Math.max(128/img.width, 128/img.height);
                        const w = img.width * ratio; 
                        const h = img.height * ratio;
                        ctx.drawImage(img, (128-w)/2, (128-h)/2, w, h);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function fetchAndEncodeIcon(url) {
            try {
                const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                const blob = await response.blob();
                return new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) { return null; }
        }

        function showNotification(message, isError = false) {
            els.notificationMessage.textContent = message;
            els.notificationToast.classList.toggle('bg-green-600', !isError);
            els.notificationToast.classList.toggle('bg-red-500', isError);
            els.notificationToast.classList.remove('translate-x-[200%]');
            els.notificationToast.classList.add('translate-x-0');
            setTimeout(() => {
                els.notificationToast.classList.remove('translate-x-0');
                els.notificationToast.classList.add('translate-x-[200%]');
            }, 3000);
        }

        function applyDragLockState(isLocked) {
            const text = isLocked ? "Unlock" : "Lock";
            els.dragLockButton.textContent = text;
            els.mobileDragLockButton.textContent = text;
            if (window.sortableInstance) window.sortableInstance.option("disabled", isLocked);
        }

        // --- EVENT LISTENERS ---
        
        // Add Menu
        const openAdd = () => { els.addMenu.classList.remove('translate-y-full'); els.addMenuOverlay.classList.remove('hidden'); };
        const closeAdd = () => { els.addMenu.classList.add('translate-y-full'); els.addMenuOverlay.classList.add('hidden'); };
        els.addButton.onclick = openAdd;
        els.cancelAddMenu.onclick = closeAdd;
        els.addMenuOverlay.onclick = closeAdd;

        // Action Menu
        const closeAction = () => { els.actionMenu.classList.add('translate-y-full'); els.actionMenuOverlay.classList.add('hidden'); };
        const openActionMenu = () => { els.actionMenu.classList.remove('translate-y-full'); els.actionMenuOverlay.classList.remove('hidden'); };
        els.cancelActionMenu.onclick = closeAction;
        els.actionMenuOverlay.onclick = closeAction;

        // Settings Menu
        const openSettings = () => { els.mobileSettingsMenu.classList.remove('translate-y-full'); els.mobileSettingsOverlay.classList.remove('hidden'); };
        const closeSettings = () => { els.mobileSettingsMenu.classList.add('translate-y-full'); els.mobileSettingsOverlay.classList.add('hidden'); };
        els.mobileSettingsButton.onclick = openSettings;
        els.cancelMobileSettingsMenu.onclick = closeSettings;
        els.mobileSettingsOverlay.onclick = closeSettings;

        // Modals (Input, Move, Delete)
        const closeInput = () => { els.inputModalOverlay.classList.add('hidden'); els.inputForm.onsubmit = null; };
        els.cancelInputModal.onclick = closeInput;
        els.inputModalOverlay.onclick = (e) => { if (e.target === els.inputModalOverlay) closeInput(); };

        const closeDelete = () => els.deleteModalOverlay.classList.add('hidden');
        els.cancelDeleteModal.onclick = closeDelete;
        els.deleteModalOverlay.onclick = (e) => { if(e.target === els.deleteModalOverlay) closeDelete(); };
        els.confirmDeleteButton.onclick = () => { deleteItem(selectedItem.id); closeDelete(); closeAction(); };

        const closeMove = () => els.moveModalOverlay.classList.add('hidden');
        els.cancelMoveModal.onclick = closeMove;
        els.moveModalOverlay.onclick = (e) => { if(e.target === els.moveModalOverlay) closeMove(); };
        els.confirmMoveButton.onclick = () => { moveItem(selectedItem.id, moveModalTargetFolderId); closeMove(); closeAction(); };

        // Buttons
        els.addLinkButton.onclick = () => { closeAdd(); openInputModal('add', 'link'); };
        els.addFolderButton.onclick = () => { closeAdd(); openInputModal('add', 'folder'); };
        els.editButton.onclick = () => { closeAction(); openInputModal('edit', selectedItem.type); };
        els.deleteButton.onclick = () => { closeAction(); els.deleteModalOverlay.classList.remove('hidden'); };
        els.moveButton.onclick = () => { 
            closeAction(); 
            moveModalTargetFolderId = 'root';
            moveModalBreadcrumbs = [{id:'root', name:'Home'}];
            renderMoveUI();
            els.moveModalOverlay.classList.remove('hidden');
        };

        els.dragLockButton.onclick = () => { isDragLocked = !isDragLocked; applyDragLockState(isDragLocked); };
        els.mobileDragLockButton.onclick = () => { isDragLocked = !isDragLocked; applyDragLockState(isDragLocked); closeSettings(); };

        // --- IMPORT/EXPORT (Cloud Version) ---
        // Export: Read from localCache (which mirrors DB)
        els.exportButton.onclick = () => doExport();
        els.mobileExportButton.onclick = () => { closeSettings(); doExport(); };
        
        function doExport() {
             const hierarchy = buildHierarchy(localCache, 'root');
             const blob = new Blob([JSON.stringify(hierarchy, null, 2)], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url; a.download = 'cloud_bookmarks.json';
             document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function buildHierarchy(cache, pid) {
             return Object.values(cache).filter(i=>i.parentId===pid).map(i => {
                 const {id, parentId, ...rest} = i;
                 if(i.type==='folder') rest.children = buildHierarchy(cache, i.id);
                 return rest;
             });
        }

        // Import
        els.importButton.onclick = () => els.importFileInput.click();
        els.mobileImportButton.onclick = () => { closeSettings(); els.importFileInput.click(); };
        
        els.importFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    await recursiveImport(data, currentFolderId);
                    showNotification("Import complete!");
                } catch(err) { console.error(err); showNotification("Import failed", true); }
                e.target.value = null;
            };
            reader.readAsText(file);
        };

        async function recursiveImport(items, pid) {
            const batch = writeBatch(db);
            // We do one batch at a time for simplicity (note: 500 limit warning if huge import)
            // Realistically need robust chunking for huge imports, but for now:
            
            const processItem = (item, parentId) => {
                const id = crypto.randomUUID();
                const docRef = doc(db, 'users', currentUser.uid, 'items', id);
                const { children, ...data } = item;
                
                data.id = id;
                data.parentId = parentId;
                if(!data.createdAt) data.createdAt = new Date().toISOString();
                
                batch.set(docRef, data);
                
                if (children && children.length > 0) {
                     // Note: We can't batch recursively easily without hitting limits. 
                     // For deep trees, we might need sequential writes.
                     // This is a simplified flat batch for demo. 
                     children.forEach(c => processItem(c, id));
                }
            };
            
            items.forEach(i => processItem(i, pid));
            await batch.commit();
        }

        // --- HELPERS FOR MODALS ---
        
        function openInputModal(mode, type = 'link') {
            els.inputForm.reset();
            els.iconUploadPreview.classList.add('hidden');
            els.itemIconUploadInput.value = ''; 
            
            els.inputModalTitle.textContent = mode === 'add' ? (type==='link'?'Add Link':'Add Folder') : 'Edit Item';
            
            if (mode === 'add') {
                els.urlInputGroup.style.display = type === 'link' ? 'block' : 'none';
                els.iconUploadGroup.style.display = type === 'link' ? 'block' : 'none';
                
                els.inputForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const name = els.itemNameInput.value;
                    const url = els.itemUrlInput.value;
                    const file = els.itemIconUploadInput.files[0];
                    const iconUrl = els.itemIconUrlInput.value;
                    
                    els.inputModalOverlay.classList.add('hidden');
                    let icon = null;
                    if (file) icon = await resizeAndEncode(file);
                    else if (iconUrl) icon = await fetchAndEncodeIcon(iconUrl);
                    
                    await addItem(type, name, url, null, icon);
                };
            } else {
                // Edit
                els.itemNameInput.value = selectedItem.name;
                const isLink = selectedItem.type === 'link';
                els.urlInputGroup.style.display = isLink ? 'block' : 'none';
                els.iconUploadGroup.style.display = isLink ? 'block' : 'none';
                
                if(isLink) {
                    els.itemUrlInput.value = selectedItem.url;
                    if(selectedItem.favicon) {
                        els.iconUploadPreview.src = selectedItem.favicon;
                        els.iconUploadPreview.classList.remove('hidden');
                    }
                }
                
                els.inputForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const name = els.itemNameInput.value;
                    const url = els.itemUrlInput.value;
                    const file = els.itemIconUploadInput.files[0];
                    const iconUrl = els.itemIconUrlInput.value;
                    
                    els.inputModalOverlay.classList.add('hidden');
                    await editItem(selectedItem.id, name, url, iconUrl, file);
                };
            }
            els.inputModalOverlay.classList.remove('hidden');
        }

        // Move UI
        function renderMoveUI() {
            els.moveBreadcrumbs.innerHTML = '';
            moveModalBreadcrumbs.forEach((crumb, index) => {
                const s = document.createElement('span');
                s.textContent = crumb.name + (index < moveModalBreadcrumbs.length - 1 ? ' > ' : '');
                s.className = "cursor-pointer hover:text-white mr-1 text-gray-400";
                s.onclick = () => {
                    moveModalTargetFolderId = crumb.id;
                    moveModalBreadcrumbs = moveModalBreadcrumbs.slice(0, index + 1);
                    renderMoveUI();
                };
                els.moveBreadcrumbs.appendChild(s);
            });

            els.moveFolderList.innerHTML = '';
            const folders = Object.values(localCache).filter(
                i => i.type === 'folder' && i.parentId === moveModalTargetFolderId && i.id !== selectedItem.id
            );
            
            if (folders.length === 0) {
                els.moveFolderList.innerHTML = '<div class="text-gray-400 text-center p-4">No subfolders</div>';
                return;
            }

            folders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = "w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700/50 transition-colors text-left";
                btn.innerHTML = `${renderIcon('folder', 'w-5 h-5 text-gray-400')} <span class="text-white">${f.name}</span>`;
                btn.onclick = () => {
                    moveModalTargetFolderId = f.id;
                    moveModalBreadcrumbs.push({id:f.id, name:f.name});
                    renderMoveUI();
                };
                els.moveFolderList.appendChild(btn);
            });
            if(lucideLoaded) lucide.createIcons();
        }

        // Icon Inputs Logic
        els.itemIconUploadInput.onchange = (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    els.iconUploadPreview.src = ev.target.result;
                    els.iconUploadPreview.classList.remove('hidden');
                    els.itemIconUrlInput.value = '';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        // --- INITIALIZATION ---
        function init() {
            lucideLoaded = typeof lucide !== 'undefined';
            if(lucideLoaded) lucide.createIcons();
            else {
                document.getElementById('lucide-script').onload = () => {
                    lucideLoaded = true;
                    lucide.createIcons();
                };
            }
            applyDragLockState(true);
        }

        init();
    </script>
</body>
</html>
